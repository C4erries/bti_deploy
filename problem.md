# Проект «Умное БТИ»

## 1. Введение

### 1.1. Назначение проекта

«Умное БТИ» — цифровая платформа, которая выступает единым окном между клиентами
(физическими и юридическими лицами) и исполнителями (геодезисты, кадастровые инженеры,
техники БТИ). Платформа помогает проверить допустимость перепланировки до начала ремонта,
упростить оформление документов и организовать работу специалистов.

### 1.2. Краткое описание

Ключевые возможности целевой системы:

- загрузка плана квартиры (фото, скан, файл) и текстового описания изменений;
- автоматический предварительный анализ с предупреждениями о технических, юридических
  и эксплуатационных рисках;
- интерактивная визуализация планируемых изменений в понятном 2D‑формате с возможностью
  просмотра 3D‑сцены;
- персонализированный «конструктор ремонта» на основе профиля пользователя;
- каталог услуг БТИ / кадастровых работ с прозрачным ценообразованием;
- единый процесс: от консультации и проверки идеи до готовых документов.

### 1.3. Проблема, которую решает проект

Для клиентов:

- непонимание процедур и требований БТИ, СНиП, ЖК РФ;
- сложный и непрозрачный процесс получения справок, выписок и технических планов;
- необходимость личных визитов, очередей и множества согласований;
- высокий риск ошибок в документах и незаконной перепланировки;
- отсутствие доступной и недорогой визуализации будущих изменений.

Для исполнителей:

- нестабильный поток заказов и сложная работа с заявками;
- высокая административная нагрузка (документооборот, коммуникация, отчётность);
- проблемы с взаиморасчётами и сроками оплат;
- ошибочные или неполные исходные данные от клиентов;
- отсутствие удобных инструментов для раннего выявления нарушений.

## 2. Цели и задачи

### 2.1. Цели

- Создать удобный и прозрачный сервис, который помогает пользователям проверять
  допустимость перепланировки до начала ремонта.
- Стать ведущим агрегатором для специалистов в сфере технической инвентаризации и кадастра.
- Снизить риски, связанные с незаконной перепланировкой и некорректными документами.
- Сформировать инструмент предварительной проверки, который разгружает БТИ и помогает
  гражданам подготовиться к официальному согласованию.

### 2.2. Задачи

- Разработать личный кабинет для клиентов и исполнителей.
- Внедрить AI‑ассистента для предварительной проверки заявок на перепланировку, который:
  - принимает текстовое описание изменений и данные плана;
  - анализирует риски (по типам: технические, юридические, финансовые, эксплуатационные);
  - классифицирует работы и формирует структурированное заключение.
- Реализовать модуль загрузки и анализа технической документации
  (фото/сканы планов, PDF‑файлы).
- Разработать интерактивный инструмент для визуализации планируемых изменений
  (2D план + 3D сцена).
- Автоматизировать процессы подачи заявок, назначения исполнителей и взаиморасчётов.
- Создать базу знаний с актуальной информацией по требованиям БТИ, СанПиН и законодательству.
- Обеспечить систему, которая может парсить и анализировать планы (jpg/PDF),
  извлекая необходимые данные для визуализации и проверки перепланировки.

## 3. Текущее состояние (MVP)

### 3.1. Backend (реализовано)

- FastAPI‑приложение с JWT‑аутентификацией и ролями (клиент, исполнитель, администратор).
- Доменная модель:
  - пользователи и профили (`User`, `ClientProfile`, `ExecutorProfile`);
  - справочники (`Service`, `District`, `HouseType`, `Department`);
  - заказы (`Order`, `OrderStatusHistory`, `OrderFile`, `OrderPlanVersion`);
  - чат и AI‑структуры (`OrderChatMessage`, `AiRisk`, `AiAnalysis`, чаты по заказам);
  - календарь исполнителей (`ExecutorAssignment`, `ExecutorCalendarEvent`).
- Основные эндпоинты:
  - аутентификация: регистрация клиента, логин, `/auth/me`;
  - публичные справочники: `/services`, `/districts`, `/house-types`;
  - публичный калькулятор: `/calc/estimate` с возвращаемым `estimatedPrice` и `PriceBreakdown`;
  - клиентские заказы: создание, просмотр, редактирование (с ограничением по статусу),
    статус‑история, работа с файлами;
  - работа с планом: хранение версий `OrderPlanVersion` в формате `Plan` (walls/zones/doors/windows);
  - чат по заказу и общий клиентский чат; делегирование сообщений в AI‑заглушку;
  - кабинет исполнителя: список заказов, деталка, взятие/отказ, календарь выездов;
  - админка: управление пользователями, исполнителями, заказами и справочниками.
- AI‑часть:
  - схемы `AiRisk` и `AiAnalysis` уже описаны в коде и OpenAPI;
  - эндпоинты анализа заказа (`/client/orders/{id}/ai/analyze`, `/client/orders/{id}/ai/analysis`)
    реализованы как заглушки, но не падают и возвращают корректный JSON.

### 3.2. Frontend (реализовано)

- React + Vite + Tailwind с разделением по ролям:
  - публичные страницы (домашняя, каталог услуг),
  - авторизация и выбор роли,
  - кабинет клиента (список заказов, создание заказа, детали заказа),
  - кабинет исполнителя (список и детали заказов, календарь выездов),
  - админ‑раздел (пользователи, исполнители, заказы, справочники).
- Клиентский заказ:
  - мастер создания заказа с выбором услуги, округа и типа дома;
  - отправка `calculatorInput` для предварительного расчёта стоимости;
  - детали заказа: файлы, история статусов, JSON‑представление плана.
- Визуализация:
  - формат `Plan` поддерживается на фронтенде;
  - 3D‑просмотр плана (`Plan3DViewer`) с отображением стен и зон, возможностью
    добавлять и перемещать объекты мебели (через `plan.objects3d`).
- AI‑интерфейс:
  - чат по заказу, отправка сообщений в AI‑заглушку;
  - вывод `AiAnalysis` в деталях заказа.

### 3.3. Ограничения MVP

- AI‑логика упрощена: нет реальной проверки норм и сложных правил, только заглушки.
- Парсинг планов из изображений/PDF не реализован — планы задаются в уже структурированном формате.
- Калькулятор стоимости использует упрощённую модель (площадь, часть параметров работ и особенностей).
- Нет полноценного модуля правил для AI и журнала ошибок в админке — только базовые структуры.

## 4. Требования к функционалу (целевое состояние)

### 4.1. Публичная часть

- Лендинг:
  - краткое описание сервиса, ключевые преимущества, FAQ;
  - блок «Как это работает» с шагами от загрузки плана до получения документов.
- Краткое описание услуг:
  - проверка перепланировки AI‑ассистентом;
  - визуализация «до/после» в 2D/3D;
  - заказ технических планов, выписок и других услуг БТИ;
  - подбор проверенных исполнителей.
- FAQ:
  - точность анализа AI (предварительная оценка, окончательное слово за инженером);
  - требования к исходным данным (какой план нужен);
  - как происходит оплата и верификация исполнителей;
  - сроки: время предварительного анализа и первой консультации.
- Каталог услуг:
  - список услуг с описанием, требуемыми документами и примером стоимости/сроков;
  - связка с калькулятором стоимости и доступностью исполнителей.

### 4.2. Личный кабинет клиента

- Навигация:
  - сайдбар с разделами «Проекты», «История запросов», «Чат».
- Мастер создания заказа:
  - выбор услуги из каталога;
  - выбор округа Краснодара и типа дома из справочников;
  - загрузка документов (план, фото, сканы).
- Парсинг и подготовка плана:
  - при загрузке плана система извлекает данные о стенах, окнах, дверях, мокрых зонах;
  - пользователь видит 2D‑визуал и может вручную скорректировать распознанные элементы;
  - результат описывается в формате `Plan`.
- Интерактивная визуализация:
  - базовый шаблон помещения, который можно редактировать:
    - перемещение объектов (стены, двери, окна);
    - удаление выбранных зон (с подсветкой: удаляемые — красным, добавляемые — зелёным, изменяемые — жёлтым);
  - переключение между режимами 2D (утверждение) и 3D (просмотр);
  - режим «до/после» с двумя версиями плана (`ORIGINAL`/`MODIFIED`).
- Конструктор ремонта:
  - сбор профиля пользователя (возраст, рост, семья, увлечения, профессия, стилевые предпочтения);
  - 2D/3D‑редактор с Drag&Drop‑элементами (мебель, отделка, освещение, декор);
  - панель свойств для настройки цвета, материалов, размеров;
  - автоматическая генерация 3–5 вариантов планировки на основе профиля и чата;
  - проверка действий пользователя в реальном времени (перенос розеток, мокрых зон и т.п.);
  - сохранение проекта на сервере и экспорт структурированного JSON
    (профиль, планировка, материалы, 2D/3D‑модель).
- AI‑ассистент:
  - чат‑интерфейс: пользователь описывает желаемые изменения;
  - анализ и вывод статуса: «Разрешено» / «Запрещено» / «Требует согласования»;
  - указание причин (ссылки на нормы и правила);
  - предупреждения о юридических и финансовых последствиях (ипотека, ликвидность);
  - предлагается несколько персонализированных вариантов перепланировки и ремонта;
  - подсветка проблемных стен и зон на 2D‑плане;
  - итоговое заключение: список изменений, 2D‑модель, список рисков и советов.
- Калькулятор стоимости перепланировки:
  - находится в мастере создания заказа, рядом с чатом AI;
  - параметры:
    - площадь квартиры;
    - округ Краснодара;
    - тип дома (панельный, кирпичный, монолитный и т.п.);
    - виды работ (чек‑лист: снос/возведение перегородок, перенос/устройство санузла, перенос сантехники,
      перенос проёмов, проёмы в несущих стенах и т.д.);
    - особенности (перенос кухни/газовой плиты, объединение квартир и др.);
  - логика:
    - базовая стоимость × коэффициент округа × коэффициент типа дома × коэффициенты особенностей;
    - итоговая стоимость — по видам работ и количеству услуг;
  - визуализация:
    - динамический подсчёт итога;
    - детализация расчёта и акцент, что стоимость ориентировочная.
- Трекер заказа:
  - отображение статуса по цепочке
    («Принят» → «Назначен исполнитель» → «Выезд назначен» → «Документы готовятся» → «Завершён»)
    с датами и комментариями.

### 4.3. Личный кабинет исполнителя

- Панель управления:
  - обзор активных заказов, фильтры по статусу, услуге и сложности;
  - сортировка от старых к новым (чтобы старые заявки не «зависали»).
- Рабочий список:
  - таблица заказов с колонками:
    - ID, статус, услуга, ориентировочная/утверждённая стоимость, дата создания;
    - кнопка «Подробнее».
- Карточка заказа:
  - общая информация, описание задачи, данные клиента и адрес;
  - документы и план (2D/3D‑визуал, версия «до/после»);
  - история статусов;
  - связь с отделами и ответственными.
- Взаимодействие с заказами:
  - возможность брать заказы в работу или отказываться;
  - просмотр запросов и комментариев клиента;
  - взаимодействие с AI‑анализом (дополнения, уточнения).
  - выбор услуги из каталога,
  - выбор округа и типа дома из справочников (через списки, а не ввод кодов),
  - загрузка документов (техпаспорт, план БТИ и др.),
  - ввод параметров для калькулятора стоимости (площадь, виды работ, особенности),
  - город и регион в доменной модели отсутствуют: система работает в одном городе/регионе.
- Визуализация:
  - базовый 2D‑план помещения и возможность редактирования (перемещение/удаление элементов),
  - подсветка изменяемых/проблемных зон (MVP — достаточно хранить план в JSON и отдавать его на фронт; сложная редактура может быть упрощена).
- AI‑ассистент (MVP):
  - чат‑интерфейс для текстового описания изменений,
  - получение предварительного заключения (разрешено/запрещено/требует согласования) с объяснением причин и рисков.
- **Утверждение изменений плана:**
  - при получении отредактированного плана от исполнителя (статус "AWAITING_CLIENT_APPROVAL") клиент получает уведомление,
  - просмотр новой версии плана с комментарием исполнителя,
  - кнопки "Принять изменения" / "Вернуть на доработку",
  - история версий плана сохраняется и доступна для просмотра.

### 5.3. Личный кабинет исполнителя

- Панель заказов:
  - список новых/текущих/завершённых заказов с фильтрами по статусу и отделу,
  - сортировка от старых к новым.
- Страница заказа:
  - общая информация (услуга, клиент, стоимость, сложность, статус),
  - доступ к загруженным документам,
  - план и история статусов,
  - возможность взять заказ или отказаться.
  - **Редактор визуализации плана:**
    - интерактивный редактор (аналогичный клиенту) с загруженным планом клиента,
    - просмотр AI-анализа и визуализация "до/после",
    - режим редактирования с подсветкой изменений:
      - красный — удаляемые элементы,
      - зеленый — новые элементы,
      - желтый — изменяемые элементы.
  - **Действия с планом:**
    - **"Одобрить"**: Переводит статус заказа в "READY_FOR_APPROVAL" (Готов к согласованию) с финальной версией плана.
    - **"Править"**: Активирует режим редактирования — перемещение объектов, удаление/добавление зон. После правок сохраняется новая версия типа "EXECUTOR_EDITED" с комментарием исполнителя и отправляется клиенту на утверждение (статус "AWAITING_CLIENT_APPROVAL").
    - **"Отклонить"**: Смена статуса на "REJECTED_BY_EXECUTOR" (Отклонён) с обязательным комментарием и списком замечаний.
- Распределение по отделам:
  - типы отделов (юридический, мастера, поддержка);
  - автоматическое назначение по типу услуги;
  - ручное перераспределение администратором.
- Календарь выездов:
  - планирование выезда с выбором доступных дат и временных слотов;
  - информация о мастере (ФИО, стаж);
  - уведомления клиенту и исполнителю о назначенном выезде.

### 4.4. Административная панель

- Аналитика по исполнителям:
  - загрузка (количество и сложность задач);
  - последняя активность;
  - среднее время выполнения заказов;
  - ошибки/отказы.
- Управление пользователями:
  - список клиентов и исполнителей;
  - фильтры по ролям;
  - изменение ролей, блокировка, просмотр истории заказов.
- Модерация заказов и исполнителей:
  - таблица заказов с фильтрами по статусу и исполнителю;
  - назначение исполнителя, отправка на доработку;
  - утверждение/отклонение заказов, комментарии модератора.
- Правила для AI:
  - создание/редактирование правил:
    - название, условие срабатывания, тип риска, описание, серьёзность (1–5), зона риска, статус, приоритет, теги;
  - предпросмотр ответа AI (тестовый JSON на основе правила);
  - массовые действия над правилами (включение/отключение, назначение тегов).
- Журнал ошибок:
  - хранение ошибок AI, backend‑логики и обработки планов (ID, дата/время, тип, входные данные, сообщение,
    критичность, статус, ответственный);
  - фильтрация и поиск по типу, статусу, ответственному.

## 5. Технические требования

- Стек:
  - Backend: FastAPI, SQLAlchemy, Pydantic, SQLite (dev), JWT‑auth.
  - Frontend: React, Vite, Tailwind.
  - Docker: общий стенд через `docker-compose`.
- API:
  - единый префикс `/api/v1`;
  - OpenAPI‑спецификация в `openapi.yaml`/`swagger.yaml` поддерживается в актуальном состоянии.
- Данные и модель:
  - доменная модель описана в SQLAlchemy‑моделях в `backend/app/models`;
  - поля `city` и `region` в API не используются — привязка к одному городу/региону;
  - для планов используется формат `Plan` (см. `backend/app/schemas/plan.py`).

## 6. Этапы развития

- Этап 1 (MVP — уже реализовано в репозитории):
  - базовые роли и аутентификация;
  - справочники и каталог услуг;
  - создание и сопровождение заказов, статус‑история;
  - хранение файлов и плана в формате `Plan`;
  - простой калькулятор стоимости и API `/calc/estimate`;
  - кабинеты клиента, исполнителя и админа с основными сценариями;
  - чат и AI‑заглушки с типизированными схемами.
- Этап 2 (ближайший фокус):
  - усиление калькулятора стоимости под требования ТЗ (виды работ, особенности, коэффициенты);
  - развитие визуализации плана и «конструктора ремонта» (2D/3D, «до/после», зонирование, подсветка изменений);
  - расширение AI‑анализа (риски, причины, подсветка зон, экспорт JSON);
  - добавление UI и API для правил AI и журнала ошибок.
- Этап 3 (расширенный продукт):
  - полноценный парсинг планов из фото и документов;
  - интеграция с внешними источниками нормативов и открытых данных;
  - продвинутые механизмы взаиморасчётов и контроля качества работы исполнителей.
  - фильтрация по ролям (клиент, исполнитель),
  - просмотр и изменение ролей, блокировка, просмотр истории заказов.
- Управление исполнителями:
  - создание исполнителя (пользователь + профиль исполнителя),
  - аналитика загрузки (текущие задачи, среднее время выполнения, ошибки/отказы).
- Заказы:
  - модерация (назначение исполнителя, отправка на доработку, утверждение/отклонение),
  - изменение статуса, цены и сроков,
  - **просмотр всех версий плана по заказу** для модерации и контроля процесса согласования.
- Справочники:
  - услуги, округа, типы домов, отделы.
- Правила/подсказки для AI и журнал ошибок:
  - каркас интерфейса и моделей для управления правилами и логом ошибок (MVP — структура данных и API без полноценной AI‑логики).

## 5.5. Workflow работы с планами

### Процесс согласования плана:

1. **Клиент создает заказ и загружает план:**
   - Заказ получает статус "SUBMITTED" (Отправлен)
   - План сохраняется как версия "ORIGINAL"

2. **Исполнитель получает заказ:**
   - После назначения заказ переходит в статус "EXECUTOR_ASSIGNED" (Назначен исполнитель)
   - Исполнитель открывает редактор плана и просматривает план клиента

3. **Действия исполнителя:**
   - **Одобрить**: Заказ переходит в статус "READY_FOR_APPROVAL" (Готов к согласованию), создается финальная версия "FINAL"
   - **Править**: Исполнитель редактирует план в интерактивном редакторе:
     - Перемещение объектов, удаление/добавление зон
     - Подсветка изменений (красный — удаляемые, зеленый — новые, желтый — изменяемые)
     - Сохранение новой версии "EXECUTOR_EDITED" с комментарием
     - Заказ переходит в статус "AWAITING_CLIENT_APPROVAL" (Ожидает утверждения клиентом)
   - **Отклонить**: Заказ переходит в статус "REJECTED_BY_EXECUTOR" (Отклонён исполнителем) с комментарием и списком замечаний

4. **Клиент получает уведомление:**
   - При статусе "AWAITING_CLIENT_APPROVAL" клиент видит новую версию плана с комментарием исполнителя
   - Кнопки действий: "Принять изменения" / "Вернуть на доработку"
   - При принятии: заказ переходит в статус "READY_FOR_APPROVAL"
   - При возврате: заказ возвращается исполнителю для доработки

5. **История версий:**
   - Все версии плана сохраняются с типом (ORIGINAL, MODIFIED, EXECUTOR_EDITED, FINAL)
   - История версий доступна в разделе "История статусов" для обеих сторон
   - Админ-панель получает просмотр всех версий плана по заказу для модерации

## 6. Текущая реализация и исходные данные

На момент подключения ИИ‑агентов в репозитории уже есть:

- Backend:
  - FastAPI + SQLAlchemy + SQLite (dev),
  - доменная модель пользователей, заказов, справочников и связанных сущностей,
  - REST API, описанное в `openapi.yaml`, частично реализовано (AI‑часть пока заглушки),
  - эндпоинты работают под префиксом `/api/v1`,
  - из модели заказов убраны поля `city` и `region` (платформа привязана к одному городу/региону).
- Frontend:
  - React + Vite + Tailwind (тестовый UI),
  - базовый функционал: авторизация, простая работа с заказами.
- Docker:
  - `backend` и `frontend` поднимаются через `docker-compose`.

Важно: `openapi.yaml` не является абсолютно жёстким источником правды. Его можно и нужно корректировать при эволюции API так, чтобы он отражал фактическое состояние и не ломал реализацию.

## 7. Ограничения и допущения

- Не менять радикально стек (FastAPI, SQLAlchemy, React, Vite, Tailwind, SQLite для dev).
- На текущем этапе AI/ML‑логика и сложная визуализация могут быть реализованы в упрощённом виде (заглушки, статические конфигурации, «моки»), главное — подготовить корректный каркас данных и API.
- Больше фокус на работоспособность ключевых бизнес‑сценариев (регистрация, логин, создание/ведение заказов, взаимодействие ролей), чем на идеальный UX или дизайн.

## 8. Критерии успеха

- Пользователь (клиент) может:
  - зарегистрироваться и войти,
  - создать заказ на основе каталога услуг, выбрав округ и тип дома из списков, не вводя коды вручную,
  - видеть статусы, файлы, простую визуализацию плана и результаты предварительного анализа.
- Исполнитель может:
  - просматривать и фильтровать свои заказы,
  - брать заказы в работу и отказываться,
  - просматривать документы и план,
  - видеть календарь выездов.
- Администратор может:
  - управлять пользователями и исполнителями,
  - управлять справочниками,
  - видеть и модифицировать заказы (назначение исполнителя, статусы, цена),
  - видеть базовую аналитику и подготовленный каркас под правила/журнал ошибок.
- Backend, OpenAPI и frontend согласованы по ключевым сценариям; изменения OpenAPI допускаются, если они согласованно внедрены в код и UI.

